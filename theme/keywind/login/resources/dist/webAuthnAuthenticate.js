import{m as U}from"./assets/module.esm-1a8ca6bf.js";import{b as a}from"./assets/rfc4648-22fd5bf4.js";let h;function S(){if(h){const e=new Error("Cancelling pending WebAuthn call");e.name="AbortError",h.abort(e)}return h=new AbortController,h.signal}async function H(e){if(!e.isUserIdentified){try{const n=await g([],e.challenge,e.userVerification,e.rpId,e.createTimeout,e.errmsg,e.additionalOptions);w(n)}catch(n){A(n instanceof Error?n.message:String(n))}return}B(e.challenge,e.userVerification,e.rpId,e.createTimeout,e.errmsg)}async function B(e,n,i,c,o){const s=[],l=document.forms.namedItem("authn_select");if(l){const t=l.elements.namedItem("authn_use_chk");if(t!=null){if(t instanceof HTMLInputElement)s.push({id:new Uint8Array(a.parse(t.value,{loose:!0})),type:"public-key"});else if(t.length!==void 0)for(let d=0;d<t.length;d++){const m=t[d];s.push({id:new Uint8Array(a.parse(m.value,{loose:!0})),type:"public-key"})}}}try{const t=await g(s,e,n,i,c,o);w(t)}catch(t){A(t instanceof Error?t.message:String(t))}}async function g(e,n,i,c,o,s,l){if(!window.PublicKeyCredential)throw new Error(s);const t={rpId:c,challenge:new Uint8Array(a.parse(n,{loose:!0}))};return o!==0&&(t.timeout=o*1e3),e.length&&(t.allowCredentials=e),i!=="not specified"&&(t.userVerification=i),navigator.credentials.get({publicKey:t,signal:S(),...l})}function w(e){if(!(e.response instanceof AuthenticatorAssertionResponse))throw new Error("Invalid response type");const n=document.getElementById("clientDataJSON"),i=document.getElementById("authenticatorData"),c=document.getElementById("signature"),o=document.getElementById("credentialId"),s=document.getElementById("userHandle"),l=document.getElementById("webauth");if(!n||!i||!c||!o||!l)throw new Error("Required form elements not found");n.value=a.stringify(new Uint8Array(e.response.clientDataJSON),{pad:!1}),i.value=a.stringify(new Uint8Array(e.response.authenticatorData),{pad:!1}),c.value=a.stringify(new Uint8Array(e.response.signature),{pad:!1}),o.value=e.id,e.response.userHandle&&s&&(s.value=a.stringify(new Uint8Array(e.response.userHandle),{pad:!1})),l.requestSubmit()}function A(e){const n=document.getElementById("error"),i=document.getElementById("webauth");if(!n||!i)throw new Error("Required form elements not found");n.value=e,i.requestSubmit()}document.addEventListener("alpine:init",()=>{U.data("webAuthnAuthenticate",function(){const{authenticatorDataInput:e,authnSelectForm:n,clientDataJSONInput:i,credentialIdInput:c,errorInput:o,signatureInput:s,userHandleInput:l,webAuthnForm:t}=this.$refs,{challenge:d,createTimeout:m,isUserIdentified:b,rpId:I,unsupportedBrowserText:E,userVerification:p}=this.$store.webAuthnAuthenticate,y=f=>{if(!window.PublicKeyCredential){o.value=E,t.submit();return}const u={challenge:new Uint8Array(a.parse(d,{loose:!0})),rpId:I};f.length&&(u.allowCredentials=f),parseInt(m)!==0&&(u.timeout=parseInt(m)*1e3),p!=="not specified"&&(u.userVerification=p),navigator.credentials.get({publicKey:u}).then(r=>{r instanceof PublicKeyCredential&&r.response instanceof AuthenticatorAssertionResponse&&(window.result=r,e.value=a.stringify(new Uint8Array(r.response.authenticatorData),{pad:!1}),i.value=a.stringify(new Uint8Array(r.response.clientDataJSON),{pad:!1}),s.value=a.stringify(new Uint8Array(r.response.signature),{pad:!1}),c.value=r.id,r.response.userHandle&&(l.value=a.stringify(new Uint8Array(r.response.userHandle),{pad:!1})),t.submit())}).catch(r=>{o.value=r,t.submit()})},v=()=>{const f=[];if(n){const u=Array.from(n.elements);u.length&&u.forEach(r=>{r instanceof HTMLInputElement&&f.push({id:new Uint8Array(a.parse(r.value,{loose:!0})),type:"public-key"})})}y(f)};return{webAuthnAuthenticate:()=>{if(!b){y([]);return}v()}}})});export{H as authenticateByWebAuthn,A as returnFailure,w as returnSuccess,S as signal};
